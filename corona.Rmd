---
title: "Corona Virus en Chile"
author: "A. Valencia"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(knitr)
library(kableExtra)
```

# Comentarios a priori

Los modelos proyectados a continuación son considerados simplistas, y por tanto los resultados acá presente no poseen la seriedad ni rigurosidad necesaria para poder considerados argumentos de peso. Lo anterior no por falta de profesionalismo si no de recursos y tiempo. 

Los resultados siguen un modelo exponencial que no toma en cuenta el período de tiempo en que los individuos son contagiosos y luego dejan de serlos. Es necesario también añadir la cantidad de recuperados y muertos en el modelo. 

Una vez que el factor de crecimiento sea consistente menor que 1, el modelo exponencial dejará de ser una aproximación válida. 

A continuación se presenta primero el modelo más actualizado y a continuación una muestra de los modelos previos constrastados con los datos reales de los días venideros. 

---

# Datos a la fecha

Fuente : https://en.wikipedia.org/wiki/2020_coronavirus_pandemic_in_Chile

```{r}
data <- read.csv2("corona_data.csv", sep = ",", header = TRUE)
data$Day <- as.Date(data$Day)
n <- nrow(data)
data$x <- 1:n
data$cum <- cumsum(data$NewCases)
latest <- data[n,1]
p <-ggplot() + ggtitle(paste("Evolución de casos al", latest)) +
    geom_line(aes(x=data$Day, y=data$cum)) + 
    geom_point(aes(x=data$Day, y=data$cum)) +
    xlab("Fecha") + ylab("Casos acumulados") + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_date(date_breaks = "1 days")
p
```

# Análisis del punto de Inflexión del modelo logístico

Cuando el factor de crecimiento sea consistentemente $<1$ podemos presumir que la curva logística habrá pasado su punto de inflexión y el modelo exponencial ha de actualizarse a uno que inculya factores de saturación.

```{r, warning=FALSE}
growth_ratio <- vector(length=(n-1))
for( i in 2:n ) {
  growth_ratio[i-1] <- data$cum[i] / data$cum[i-1]
}
# La primera muestra es espuria
growth_ratio[1] <- NA
ggplot() + ggtitle("Factor de crecimiento") + 
  geom_point(aes(x=data$Day[2:n], y=growth_ratio, color="crecimiento")) + 
  geom_line(aes(x=data$Day[2:n], y=growth_ratio, color="crecimiento")) + 
  xlab("Fecha") + ylab("Growth rate") +
  ylim(0,(max(growth_ratio)+0.5)) +
  geom_hline(yintercept = 1, aes(color="y=1"))
  
```


# Proyección a 3 días (modelo exponencial simple)

Los resultados del 15 de Marzo fueron inesperadamente altos. Es muestra de que las medidas para el confinamiento del virus no han sido efectivos (o de que las estadísticas anteriores a ese día no son confiables). 

Es necesario observar más días en la serie para poder determinar si el aumento abrupto es una medida ruidosa o efectivamente marca tendencia.

Al momento el modelo proyectado explica $\approx98\%$ de la varianza de los datos. 

```{r}
model <- lm(formula = log(cum) ~ x , data=data)

test_data <- data.frame(
                Day = seq(data$Day[1], by="day", length.out = (n+3)), 
                x = 1:(n+3)
              )

test_data$preds <- exp(predict(model, newdata=test_data))

p <-ggplot() + ggtitle(paste("Proyección")) +
    geom_point(aes(x=data$Day, y=data$cum, color="casos reales")) + 
    geom_line(aes(x=test_data$Day, y=test_data$preds, color="modelo")) + 
    xlab("Fecha") + ylab("Casos acumulados") + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_date(date_breaks = "1 days")
p
```

## Casos proyectados para los próximos días.

```{r}
print_test <- test_data
print_test$x <- c()
print_test <- tail(print_test, n=3)
print_test %>%  kable(digits=0) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
```

## Estadísticas del modelo

```{r}
summary(model)
```

---

# Modelos anteriores

```{r}
run_model <- function(data, date_split) {
  train_idxs <- which(data$Day <= date_split)
  train <- data[train_idxs,]
  test  <- data[-train_idxs,]
  model <- lm(formula = log(cum) ~ x, data=train)
  test$preds <- exp(predict(model, newdata=test))
  
  error <- sqrt(mean(test$cum - test$preds)^2)
  cat("RMS error = ", error, "personas")
  
  p <-ggplot() + ggtitle(paste("Modelo al", date_split)) +
      geom_point(aes(x=data$Day, y=data$cum, color="casos reales")) + 
      geom_point(aes(x=test$Day, y=test$preds, color="predicción")) + 
      geom_line(aes(x=data$Day, y=data$cum, color="casos reales")) + 
      xlab("Fecha") + ylab("Casos acumulados") + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      scale_x_date(date_breaks = "1 days")
  if (length(test$preds) > 1) {
    p <- p + geom_line(aes(x=test$Day, y=test$preds, color="predicción")) 
  }
  p
}
```


## Modelo al 15-Mar
```{r}
run_model(data, "2020-03-15")
```


## Modelo al 14-Mar
```{r}
run_model(data, "2020-03-14")
```



## Modelo al 13-Mar
```{r}
run_model(data, "2020-03-13")
```




























































