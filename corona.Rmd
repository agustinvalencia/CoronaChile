---
title: "Corona Virus en Chile"
author: "A. Valencia"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(knitr)
library(kableExtra)
```

# Comentarios a priori

Los modelos proyectados a continuación son considerados simplistas, y por tanto los resultados acá presente no poseen la seriedad ni rigurosidad necesaria para poder considerados argumentos de peso. Lo anterior no por falta de profesionalismo si no de recursos y tiempo. 

Los resultados siguen un modelo exponencial que no toma en cuenta el período de tiempo en que los individuos son contagiosos y luego dejan de serlos. Es necesario también añadir la cantidad de recuperados y muertos en el modelo. 

Una vez que el factor de crecimiento sea consistente menor que 1, el modelo exponencial dejará de ser una aproximación válida. 

A continuación se presenta primero el modelo más actualizado y a continuación una muestra de los modelos previos constrastados con los datos reales de los días venideros. 

---

# Datos a la fecha

Fuente : https://en.wikipedia.org/wiki/2020_coronavirus_pandemic_in_Chile

```{r}
data <- read.csv2("corona_data.csv", sep = ",", header = TRUE)
data$Day <- as.Date(data$Day)
n <- nrow(data)
data$x <- 1:n
data$cum <- cumsum(data$NewCases)
latest <- data[n,1]
p <-ggplot() + ggtitle(paste("Evolución de casos al", latest)) +
    geom_line(aes(x=data$Day, y=data$cum)) + 
    geom_point(aes(x=data$Day, y=data$cum)) +
    xlab("Fecha") + ylab("Casos acumulados") + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_date(date_breaks = "1 days")
p
```

# Análisis del punto de Inflexión del modelo logístico

Cuando el factor de crecimiento sea consistentemente $<1$ podemos presumir que la curva logística habrá pasado su punto de inflexión y el modelo exponencial ha de actualizarse a uno que inculya factores de saturación.

```{r, warning=FALSE}
growth_ratio <- vector(length=(n-1))
for( i in 2:n ) {
  growth_ratio[i-1] <- data$cum[i] / data$cum[i-1]
}
# La primera muestra es espuria
growth_ratio[1] <- NA
ggplot() + ggtitle("Factor de crecimiento") + 
  geom_point(aes(x=data$Day[2:n], y=growth_ratio, color="crecimiento")) + 
  geom_line(aes(x=data$Day[2:n], y=growth_ratio, color="crecimiento")) + 
  xlab("Fecha") + ylab("Growth rate") +
  ylim(0,(max(growth_ratio)+0.5)) +
  geom_hline(yintercept = 1, aes(color="y=1"))
  
```

# Proyección a 1 semana (ensembled model)

```{r}
source("./ensemble.R")
forecast = 7
results = ensemble_models(data, burndown = 10, forecast = forecast)
preds = results[,-1:-2]
majority_knowledge = rowMeans(preds)
ggplot() + ggtitle("Proyección Ensembled Model") +
    geom_point(aes(x=data$Day, y=data$cum, color="Casos Reales")) + 
    geom_line(aes(x=results$Day, y=majority_knowledge, color="Ensembled Model"))
print_test = data.frame( Day = results$Day, Prediction = majority_knowledge)
print_test = print_test[(n+1):nrow(print_test),]

print_test %>%  kable(digits=0) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
```

```{r}
mse = 1/n * sum((data$cum - majority_knowledge[1:n])^2)
error = sqrt(mse)
cat(" El error promedio de las predicciones es =", error, "personas")
```

# Proyección a 1 semana (modelo exponencial simple)

```{r}
model <- lm(formula = log(cum) ~ x , data=data)

test_data <- data.frame(
                Day = seq(data$Day[1], by="day", length.out = (n+7)), 
                x = 1:(n+7)
              )

test_data$preds <- exp(predict(model, newdata=test_data))

p <-ggplot() + ggtitle(paste("Proyección")) +
    geom_point(aes(x=data$Day, y=data$cum, color="casos reales")) + 
    geom_line(aes(x=test_data$Day, y=test_data$preds, color="modelo")) + 
    xlab("Fecha") + ylab("Casos acumulados") + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    scale_x_date(date_breaks = "1 days")
p
```
```{r}
mse = 1/n * sum((data$cum - test_data$preds[1:n])^2)
error = sqrt(mse)
cat(" El error promedio de las predicciones es =", error, "personas")
```

## Week forecast

```{r}
print_test <- test_data
print_test$x <- c()
print_test <- tail(print_test, n=7)
print_test %>%  kable(digits=0) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = FALSE)
```

## Estadísticas del modelo

```{r}
summary(model)
```

---

# Modelos anteriores

```{r}
run_model <- function(data, date_split) {
  train_idxs <- which(data$Day <= date_split)
  train <- data[train_idxs,]
  test  <- data[-train_idxs,]
  model <- lm(formula = log(cum) ~ x, data=train)
  test$preds <- exp(predict(model, newdata=test))
  
  p <-ggplot() + ggtitle(paste("Modelo al", date_split)) +
      geom_point(aes(x=data$Day, y=data$cum, color="casos reales")) + 
      geom_point(aes(x=test$Day, y=test$preds, color="predicción")) + 
      geom_line(aes(x=data$Day, y=data$cum, color="casos reales")) + 
      xlab("Fecha") + ylab("Casos acumulados") + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      scale_x_date(date_breaks = "1 days")
  if (length(test$preds) > 1) {
    p <- p + geom_line(aes(x=test$Day, y=test$preds, color="predicción")) 
  }
  p
}
```


## Modelo al 22-Mar
```{r}
run_model(data, "2020-03-22")
```


## Modelo al 21-Mar
```{r}
run_model(data, "2020-03-21")
```


## Modelo al 20-Mar
```{r}
run_model(data, "2020-03-20")
```


## Modelo al 19-Mar
```{r}
run_model(data, "2020-03-19")
```


## Modelo al 18-Mar
```{r}
run_model(data, "2020-03-18")
```


## Modelo al 17-Mar
```{r}
run_model(data, "2020-03-17")
```


## Modelo al 16-Mar
```{r}
run_model(data, "2020-03-16")
```


## Modelo al 15-Mar
```{r}
run_model(data, "2020-03-15")
```


## Modelo al 14-Mar
```{r}
run_model(data, "2020-03-14")
```


## Modelo al 13-Mar
```{r}
run_model(data, "2020-03-13")
```




























































